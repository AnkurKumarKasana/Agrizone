{% extends 'base.html' %}

{% block title %}AI Assistant - Agrizone{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: var(--card-bg);
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message-content {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        position: relative;
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-bottom-right-radius: 0.25rem;
    }
    
    .message.bot .message-content {
        background-color: #f8f9fa;
        color: var(--text-color);
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 0.25rem;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 0.5rem;
        font-size: 1.2rem;
    }
    
    .message.user .message-avatar {
        background: var(--primary-color);
        color: white;
        order: 2;
    }
    
    .message.bot .message-avatar {
        background: var(--secondary-color);
        color: white;
    }
    
    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    
    .typing-indicator {
        display: none;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .typing-dots {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        background-color: #f8f9fa;
        border-radius: 1rem;
        border-bottom-left-radius: 0.25rem;
        margin-left: 0.5rem;
    }
    
    .typing-dots span {
        height: 8px;
        width: 8px;
        background-color: #999;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    .suggestion-btn {
        margin: 2px;
        border-radius: 20px;
        transition: all 0.3s ease;
    }
    
    .suggestion-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .message-content {
        line-height: 1.6;
        word-wrap: break-word;
    }
    
    .chat-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: none;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .message.bot .message-content {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        box-shadow: 0 2px 4px rgba(0,123,255,0.3);
    }
    
    .card {
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-radius: 15px;
        overflow: hidden;
    }
    
    .form-control {
        border-radius: 25px;
        border: 2px solid #e9ecef;
        padding: 12px 20px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    .btn-primary {
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,123,255,0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="text-center mb-5" data-aos="fade-up">
                <h2 class="display-5 fw-bold">ðŸŒ± AgriGPT Assistant</h2>
                <p class="lead">Your intelligent farming companion - Ask me anything about agriculture, crops, or farming practices!</p>
                <div class="badge bg-success mb-3">Powered by Advanced AI</div>
            </div>
            
            <div class="card" data-aos="fade-up" data-aos-delay="200">
                <div class="card-body p-0">
                    <div class="chat-container" id="chatContainer">
                        <div class="message bot">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div>ðŸ‘‹ Hello! I'm AgriGPT, your intelligent farming assistant powered by advanced AI. I can help you with:
                                <br>â€¢ Crop cultivation and management
                                <br>â€¢ Soil health and fertilization
                                <br>â€¢ Pest and disease control
                                <br>â€¢ Weather and irrigation advice
                                <br>â€¢ Sustainable farming practices
                                <br>â€¢ And much more!
                                <br><br>What agricultural question can I help you with today?</div>
                                <div class="message-time">Just now</div>
                            </div>
                        </div>
                        
                        <div class="typing-indicator" id="typingIndicator">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-3 border-top">
                        <form id="chatForm" class="d-flex gap-2">
                            <input type="text" class="form-control" id="messageInput" placeholder="Ask me anything about farming, crops, soil, pests, weather..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12" data-aos="fade-up">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Try These Questions</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><button class="btn btn-outline-success btn-sm suggestion-btn"><i class="fas fa-seedling me-2"></i>Best fertilizer for tomatoes?</button></li>
                                        <li class="mb-2"><button class="btn btn-outline-warning btn-sm suggestion-btn"><i class="fas fa-bug me-2"></i>Natural pest control methods</button></li>
                                        <li class="mb-2"><button class="btn btn-outline-info btn-sm suggestion-btn"><i class="fas fa-leaf me-2"></i>How to improve soil health?</button></li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><button class="btn btn-outline-info btn-sm suggestion-btn"><i class="fas fa-calendar me-2"></i>Which crops are good in November?</button></li>
                                        <li class="mb-2"><button class="btn btn-outline-primary btn-sm suggestion-btn"><i class="fas fa-tint me-2"></i>When should I water my plants?</button></li>
                                        <li class="mb-2"><button class="btn btn-outline-warning btn-sm suggestion-btn"><i class="fas fa-harvest me-2"></i>When to harvest my crops?</button></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessageWithTyping(message, 'user');
    messageInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send message to server
    fetch('{% url "chatbot:send_message" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        hideTypingIndicator();
        if (data.success) {
            addMessageWithTyping(data.response, 'bot', data.timestamp);
        } else {
            addMessageWithTyping('I can help you with farming questions! Try asking about crops, soil, or pest control.', 'bot');
        }
    })
    .catch(error => {
        hideTypingIndicator();
        addMessageWithTyping('I can help you with farming questions! Try asking about crops, soil, or pest control.', 'bot');
        console.error('Error:', error);
    });
});

function addMessage(content, sender, timestamp = null) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const time = timestamp || new Date().toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    });
    
    const avatarIcon = sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="${avatarIcon}"></i>
        </div>
        <div class="message-content">
            <div>${content}</div>
            <div class="message-time">${time}</div>
        </div>
    `;
    
    // Insert before typing indicator
    const typingIndicator = document.getElementById('typingIndicator');
    chatContainer.insertBefore(messageDiv, typingIndicator);
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function showTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    typingIndicator.style.display = 'flex';
    
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    typingIndicator.style.display = 'none';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Auto-focus on message input
document.getElementById('messageInput').focus();

// Handle suggestion button clicks
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('suggestion-btn') || e.target.closest('.suggestion-btn')) {
        const button = e.target.classList.contains('suggestion-btn') ? e.target : e.target.closest('.suggestion-btn');
        const question = button.textContent.trim();
        const messageInput = document.getElementById('messageInput');
        messageInput.value = question;
        messageInput.focus();
        
        // Optionally auto-send the message
        document.getElementById('chatForm').dispatchEvent(new Event('submit'));
    }
});

// Add typing effect to messages
function typeMessage(element, text, speed = 30) {
    element.innerHTML = '';
    let i = 0;
    const timer = setInterval(() => {
        if (i < text.length) {
            element.innerHTML += text.charAt(i);
            i++;
        } else {
            clearInterval(timer);
        }
    }, speed);
}

// Enhanced message adding with typing effect for bot messages
function addMessageWithTyping(content, sender, timestamp = null) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const time = timestamp || new Date().toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    });
    
    const avatarIcon = sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="${avatarIcon}"></i>
        </div>
        <div class="message-content">
            <div class="message-text"></div>
            <div class="message-time">${time}</div>
        </div>
    `;
    
    // Insert before typing indicator
    const typingIndicator = document.getElementById('typingIndicator');
    chatContainer.insertBefore(messageDiv, typingIndicator);
    
    const messageText = messageDiv.querySelector('.message-text');
    
    if (sender === 'bot') {
        // Type effect for bot messages
        typeMessage(messageText, content, 20);
    } else {
        // Instant display for user messages
        messageText.innerHTML = content;
    }
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
}
</script>
{% endblock %}